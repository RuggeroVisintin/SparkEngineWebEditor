name: Test Release Please

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'release-please-config.json'
      - '.release-please-manifest.json'
      - 'tests/ci/**'
  pull_request:
    paths:
      - 'release-please-config.json'
      - '.release-please-manifest.json'
      - 'tests/ci/**'

jobs:
  test_dry_run:
    name: Release Please Dry Run with Feature Flag Filtering
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      FEATURE_TEST_FLAG_ENABLED: true
      FEATURE_TEST_FLAG_DISABLED: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
      - name: Create test branch with test commits
        run: |
          # Create a unique test branch to avoid clashes
          TEST_BRANCH="test-release-please-$(date +%s)"
          git checkout -b "$TEST_BRANCH"
          
          # Create test commits
          bash tests/ci/create-test-commits.sh
          
          # Show created commits
          echo "Created commits on branch: $TEST_BRANCH"
          git log --oneline -n 3
          
          # Push branch to GitHub so release-please can access config files
          git push origin "$TEST_BRANCH"
          
          # Save branch name for later steps
          echo "TEST_BRANCH=$TEST_BRANCH" >> $GITHUB_ENV
      
      - name: Install release-please and run dry-run test
        run: |
          echo "Running release-please with integrated feature-flags plugin"
          echo "Enabled flags: FEATURE_TEST_FLAG_ENABLED"
          echo "Disabled flags: FEATURE_TEST_FLAG_DISABLED"
          
          # Install dependencies (which includes release-please fork)
          npm ci
          
          # Run release-please from the fork (installed via package.json)
          npx release-please release-pr \
            --token="${{ secrets.GITHUB_TOKEN }}" \
            --repo-url="${{ github.repository }}" \
            --target-branch="${{ env.TEST_BRANCH }}" \
            --dry-run | tee /tmp/release-please-output.txt
      
      - name: Verify changelog content
        if: always()
        run: |
          echo "Verifying changelog contains only expected commits..."
          cat /tmp/release-please-output.txt | bash tests/ci/verify-changelog.sh
      
      - name: Cleanup test branch
        if: always()
        run: |
          echo "Cleaning up test branch: ${{ env.TEST_BRANCH }}"
          git push origin --delete "${{ env.TEST_BRANCH }}" || echo "Branch already deleted or does not exist"
